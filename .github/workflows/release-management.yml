name: Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.3)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      create_github_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean
      deploy_to_production:
        description: 'Deploy to production'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'

jobs:
  # Semantic versioning and changelog
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      release-notes: ${{ steps.release-notes.outputs.notes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ./vizualni-admin

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag
            VERSION="${{ github.ref_name }}"
            VERSION=${VERSION#v}  # Remove 'v' prefix if present
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

          # Validate version format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION (expected x.y.z)"
            exit 1
          fi

      - name: Generate changelog
        id: changelog
        run: |
          cd ./vizualni-admin

          # Install conventional-changelog if not present
          npm install --save-dev conventional-changelog-cli

          # Get last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            echo "Generating changelog since $LAST_TAG"

            # Generate changelog
            CHANGELOG=$(npx conventional-changelog -p angular -i CHANGELOG.md -s)

            # Get changes since last tag
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)

            cat > release-changelog.md << EOF
          ## Changes since $LAST_TAG

          $COMMITS

          EOF

          else
            echo "Generating initial changelog"
            npx conventional-changelog -p angular -i CHANGELOG.md -s --first-release

            cat > release-changelog.md << EOF
          ## Initial Release

          This is the initial release of vizualni-admin with comprehensive features including:
          - React 18 + TypeScript + Next.js support
          - Feature-based architecture
          - Serbian language localization
          - Comprehensive component library
          - Full test coverage and accessibility support
          - Performance optimization
          - Developer experience tools

          EOF
          fi

          # Read generated changelog
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG_CONTENT=$(cat CHANGELOG.md)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          # Read release notes
          if [ -f "release-changelog.md" ]; then
            RELEASE_NOTES=$(cat release-changelog.md)
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        run: |
          cd ./vizualni-admin

          VERSION="${{ steps.version.outputs.version }}"
          npm version $VERSION --no-git-tag-version

          echo "Updated package.json to version $VERSION"

      - name: Update version in configuration files
        run: |
          cd ./vizualni-admin

          VERSION="${{ steps.version.outputs.version }}"

          # Update version in any other configuration files
          if [ -f "src/version.ts" ]; then
            sed -i.bak "s/VERSION = .*/VERSION = '$VERSION'/" src/version.ts
          fi

          # Update README if it contains version
          if grep -q "version.*[0-9]\+\.[0-9]\+\.[0-9]\+" README.md; then
            sed -i.bak "s/version.*[0-9]\+\.[0-9]\+\.[0-9]\+/version $VERSION/" README.md
          fi

      - name: Commit version changes
        run: |
          cd ./vizualni-admin

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add and commit changes
          git add package.json CHANGELOG.md release-changelog.md

          # Update other files if they were modified
          git add src/version.ts README.md || true

          git commit -m "chore(release): version ${{ steps.version.outputs.version }}"

          # Tag the release
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"

      - name: Push changes and tags
        run: |
          git push origin ${{ github.ref_name }}
          git push origin v${{ steps.version.outputs.version }}

  # Build and test release
  build-release:
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ./vizualni-admin

      - name: Build for production
        run: |
          cd ./vizualni-admin

          echo "üèóÔ∏è Building release ${{ needs.prepare-release.outputs.version }}"

          # Full production build
          npm run build

          # Build storybook
          npm run build-storybook

          # Generate documentation
          npm run build:docs

          # Create distribution package
          mkdir -p dist-release
          cp -r dist/* dist-release/
          cp -r storybook-static dist-release/storybook
          cp -r docs/.vitepress/dist dist-release/docs 2>/dev/null || true

          # Create release manifest
          cat > dist-release/release-manifest.json << EOF
          {
            "version": "${{ needs.prepare-release.outputs.version }}",
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "bundleSize": "$(du -sh dist-release | cut -f1)",
            "features": {
              "react18": true,
              "typescript": true,
              "nextjs": true,
              "serbianLocalization": true,
              "featureArchitecture": true,
              "accessibility": true,
              "testing": true,
              "storybook": true
            }
          }
          EOF

      - name: Run full test suite
        run: |
          cd ./vizualni-admin

          echo "üß™ Running comprehensive test suite"

          # Unit and integration tests
          npm run test:ci

          # E2E tests
          npm run test:e2e

          # Accessibility tests
          npm run test -- --testNamePattern="a11y|accessibility"

          # Visual regression tests
          npm run test:visual || true

      - name: Security audit
        run: |
          cd ./vizualni-admin

          echo "üîí Running security audit"

          # npm audit
          npm audit --audit-level moderate

      - name: Performance validation
        run: |
          cd ./vizualni-admin

          echo "‚ö° Running performance validation"

          # Bundle size analysis
          npm run analyze

          # Lighthouse performance check
          npm run build
          npm run preview &
          SERVER_PID=$!

          sleep 10

          # Install and run Lighthouse
          npm install -g @lhci/cli@0.12.x

          cat > lighthouserc.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                url: ['http://localhost:4173'],
                startServerCommand: 'npm run preview',
                startServerReadyPattern: 'Local:',
              },
              assert: {
                assertions: {
                  'categories:performance': ['error', { minScore: 0.85 }],
                  'categories:accessibility': ['error', { minScore: 0.95 }],
                  'categories:best-practices': ['warn', { minScore: 0.85 }],
                },
              },
            },
          };
          EOF

          lhci autorun

          kill $SERVER_PID 2>/dev/null || true

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.prepare-release.outputs.version }}
          path: |
            ./vizualni-admin/dist-release/
            ./vizualni-admin/coverage/
            ./vizualni-admin/playwright-report/
          retention-days: 90

  # Create GitHub release
  create-github-release:
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_github_release == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.prepare-release.outputs.version }}
          path: ./release-files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          name: Release v${{ needs.prepare-release.outputs.version }}
          body: |
            # üéâ vizualni-admin v${{ needs.prepare-release.outputs.version }}

            ${{ needs.prepare-release.outputs.release-notes }}

            ## üì¶ Installation

            ```bash
            npm install vizualni-admin@${{ needs.prepare-release.outputs.version }}
            ```

            ## üöÄ Quick Start

            ```typescript
            import { VizualniAdminProvider, Button, DataTable } from 'vizualni-admin';

            function App() {
              return (
                <VizualniAdminProvider locale="sr">
                  <DataTable data={data} />
                  <Button variant="primary">–ê–∫—Ü–∏—ò–∞</Button>
                </VizualniAdminProvider>
              );
            }
            ```

            ## üîó Links

            - [Documentation](https://vizualni-admin.com/docs)
            - [Storybook](https://vizualni-admin.com/storybook)
            - [GitHub Repository](https://github.com/your-org/vizualni-admin)
            - [Change Log](https://github.com/your-org/vizualni-admin/blob/main/CHANGELOG.md)

            ---

            ü§ñ Generated with [GitHub Actions](https://github.com/features/actions)
          files: |
            ./release-files/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          # Update latest tag to point to this release
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git fetch --tags
          git tag -f latest v${{ needs.prepare-release.outputs.version }}
          git push origin -f latest

  # Publish to npm
  publish-to-npm:
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci
        working-directory: ./vizualni-admin

      - name: Build package
        run: |
          cd ./vizualni-admin

          npm run build

      - name: Publish to npm
        run: |
          cd ./vizualni-admin

          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        run: |
          # Verify the package was published
          PACKAGE_VERSION="${{ needs.prepare-release.outputs.version }}"
          PACKAGE_INFO=$(npm view vizualni-admin@$PACKAGE_VERSION)

          if [ -n "$PACKAGE_INFO" ]; then
            echo "‚úÖ Package vizualni-admin@$PACKAGE_VERSION published successfully"
            echo "Package info: $PACKAGE_INFO"
          else
            echo "‚ùå Package publication failed"
            exit 1
          fi

  # Deploy to production (optional)
  deploy-production:
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, publish-to-npm]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.deploy_to_production == 'true'

    environment: production

    steps:
      - name: Deploy to production
        run: |
          echo "üöÄ Deploying vizualni-admin v${{ needs.prepare-release.outputs.version }} to production"

          # Add your production deployment logic here
          # This could be:
          # - Deploy to Vercel
          # - Deploy to Netlify
          # - Deploy to AWS S3/CloudFront
          # - Deploy to Kubernetes
          # - Update CDN

      - name: Run production smoke tests
        run: |
          echo "üß™ Running production smoke tests"

          # Add smoke test logic here
          # Verify the deployment is working correctly

      - name: Update deployment status
        run: |
          echo "‚úÖ Production deployment complete"

          # Send notifications, update dashboards, etc.

  # Rollback strategy
  rollback-strategy:
    runs-on: ubuntu-latest
    needs: [publish-to-npm]
    if: failure() && (needs.publish-to-npm.result == 'failure')

    steps:
      - name: Handle rollback
        run: |
          echo "üîÑ Handling rollback scenario"

          # Get previous stable version
          PREVIOUS_VERSION=$(npm view vizualni-admin version)
          echo "Previous stable version: $PREVIOUS_VERSION"

          # Rollback logic would go here
          # - Unpublish broken version if necessary
          # - Alert team
          # - Document incident

          echo "‚ö†Ô∏è Release failed. Previous stable version: $PREVIOUS_VERSION"
          echo "üîß Please investigate the failure and retry the release."

  # Post-release notifications
  notify-release:
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, create-github-release, publish-to-npm]
    if: always()

    steps:
      - name: Notify release status
        run: |
          echo "üì¢ Release Status Summary"
          echo "========================"
          echo "Version: ${{ needs.prepare-release.outputs.version }}"
          echo "Prepare Release: ${{ needs.prepare-release.result }}"
          echo "Build Release: ${{ needs.build-release.result }}"
          echo "GitHub Release: ${{ needs.create-github-release.result }}"
          echo "NPM Publish: ${{ needs.publish-to-npm.result }}"

          if [ "${{ needs.publish-to-npm.result }}" == "success" ]; then
            echo "üéâ Release completed successfully!"
            echo "üì¶ Package available: npm install vizualni-admin@${{ needs.prepare-release.outputs.version }}"
          else
            echo "‚ùå Release failed. Please check the logs."
          fi

      - name: Update release metrics
        run: |
          echo "üìä Updating release metrics"

          # Update any dashboards or metrics
          # This could be:
          # - GitHub statistics
          # - Internal dashboards
          # - Slack notifications
          # - Email alerts