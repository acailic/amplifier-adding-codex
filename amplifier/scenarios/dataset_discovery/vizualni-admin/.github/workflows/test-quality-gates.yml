name: Testing Quality Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint

    - name: Run TypeScript check
      run: npm run type-check

    - name: Run unit tests with coverage
      run: npm run test:ci

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Run accessibility tests
      run: npm run test:e2e -- --grep "Accessibility"

    - name: Upload accessibility test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: accessibility-test-results
        path: test-results/

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build application
      run: npm run build:static

    - name: Run visual regression tests
      run: npm run test:visual

    - name: Upload visual regression results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: visual-regression-results
        path: test-results/

  serbian-localization:
    name: Serbian Localization Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Run Serbian localization tests
      run: npm run test:e2e -- --grep "Serbian Localization"

    - name: Check Serbian text rendering
      run: |
        npm run test:ci -- --testPathPattern=serbian

    - name: Upload localization test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: localization-test-results
        path: test-results/

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level high

    - name: Run dependency check
      run: npx audit-ci --moderate

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build application
      run: npm run build:static

    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    - name: Bundle size analysis
      run: |
        npx bundlesize

    - name: Performance test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: performance-test-results
        path: .lighthouseci/

  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: [unit-tests, accessibility-tests, visual-regression, serbian-localization, security-audit, performance-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check test coverage
      run: |
        COVERAGE_THRESHOLD=90
        echo "Checking if test coverage meets threshold of ${COVERAGE_THRESHOLD}%"

        # Parse coverage from test results
        if [[ -f "coverage/coverage-summary.json" ]]; then
          LINES_PCT=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          FUNCTIONS_PCT=$(jq '.total.functions.pct' coverage/coverage-summary.json)
          BRANCHES_PCT=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          STATEMENTS_PCT=$(jq '.total.statements.pct' coverage/coverage-summary.json)

          echo "Lines coverage: ${LINES_PCT}%"
          echo "Functions coverage: ${FUNCTIONS_PCT}%"
          echo "Branches coverage: ${BRANCHES_PCT}%"
          echo "Statements coverage: ${STATEMENTS_PCT}%"

          # Check if all metrics meet threshold
          if (( $(echo "$LINES_PCT >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "✅ Lines coverage meets threshold"
          else
            echo "❌ Lines coverage below threshold"
            exit 1
          fi

          if (( $(echo "$FUNCTIONS_PCT >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "✅ Functions coverage meets threshold"
          else
            echo "❌ Functions coverage below threshold"
            exit 1
          fi

          if (( $(echo "$BRANCHES_PCT >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "✅ Branches coverage meets threshold"
          else
            echo "❌ Branches coverage below threshold"
            exit 1
          fi

          if (( $(echo "$STATEMENTS_PCT >= $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "✅ Statements coverage meets threshold"
          else
            echo "❌ Statements coverage below threshold"
            exit 1
          fi
        else
          echo "❌ Coverage report not found"
          exit 1
        fi

    - name: Generate quality report
      run: |
        echo "# Quality Gate Report" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Accessibility Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Visual Regression: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Serbian Localization: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Security Audit: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Performance Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Coverage Metrics" >> $GITHUB_STEP_SUMMARY
        echo "All coverage metrics meet the ${COVERAGE_THRESHOLD}% threshold." >> $GITHUB_STEP_SUMMARY

    - name: Create quality badge
      if: success()
      run: |
        echo "Creating quality gate badge..."
        # This would create or update a quality badge for the repository
        echo "✅ All quality gates passed!"